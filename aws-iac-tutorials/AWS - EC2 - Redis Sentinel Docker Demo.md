
## Docker and Docker Compose Install
[[AWS - EC2 - Install Docker & Docker Compose on Amazon Linux]]

## Configuration File structure

```shell
sudo tree
```

```
.
├── conf1
│   └── sentinel1.conf
├── conf2
│   └── sentinel2.conf
├── conf3
│   └── sentinel3.conf
├── data1
├── data2
├── data3
├── redis.yml
└── sentinel.yml
```

## Replication install

Edit `redis.yml`
```
version: '3'
services:
  master:
    image: redis
    container_name: redis-master
    command: redis-server --requirepass redis_pwd  --masterauth redis_pwd
    ports:
      - 6380:6379
  slave1:
    image: redis
    container_name: redis-slave-1
    ports:
      - 6381:6379
    command:  redis-server --slaveof redis-master 6379 --requirepass redis_pwd --masterauth redis_pwd
  slave2:
    image: redis
    container_name: redis-slave-2
    ports:
      - 6382:6379
    command: redis-server --slaveof redis-master 6379 --requirepass redis_pwd --masterauth redis_pwd
```

```
docker compose -f redis.yml up -d
```

```
docker compose -f redis.yml down
```

## Sentinel Install

Edit `sentinel.yml`
```
version: '3.7'
services:
  sentinel1:
    image: redis
    container_name: redis-sentinel-1
    restart: always
    ports:
      - 26379:26379
    command: redis-sentinel /usr/local/etc/redis/conf/sentinel1.conf
    volumes:
      # - ./conf1/sentinel1.conf:/usr/local/etc/redis/conf/sentinel.conf
      - ./data1:/data
      - ./conf1:/usr/local/etc/redis/conf
  sentinel2:
    image: redis
    container_name: redis-sentinel-2
    restart: always
    ports:
    - 26380:26379
    command: redis-sentinel /usr/local/etc/redis/conf/sentinel2.conf
    volumes:
      # - ./conf2/sentinel2.conf:/usr/local/etc/redis/conf/sentinel.conf
      - ./data2:/data
      - ./conf2:/usr/local/etc/redis/conf
  sentinel3:
    image: redis
    container_name: redis-sentinel-3
    ports:
      - 26381:26379
    command: redis-sentinel /usr/local/etc/redis/conf/sentinel3.conf
    volumes:
      # - ./conf3/sentinel3.conf:/usr/local/etc/redis/conf/sentinel.conf
      - ./data3:/data
      - ./conf3:/usr/local/etc/redis/conf
networks:
  default:
    external: true
    name: root_default
```

```
docker compose -f sentinel.yml up -d
```

```
docker compose -f sentinel.yml down
```

Edit `sentinel.conf`, three configuration files are all same

configuration edited manually
```
port 26379
dir "/tmp"
sentinel monitor mymaster 172.19.0.4 6379 2
sentinel auth-pass mymaster redis_pwd
sentinel deny-scripts-reconfig yes
```

NOTES: This IP should your host's IP address.

configuration auto generated
```
# Generated by CONFIG REWRITE
latency-tracking-info-percentiles 50 99 99.9
user default on nopass sanitize-payload ~* &* +@all
sentinel myid 06b560bee4c7d0de8b81fd76e38a6244a0c826ce
sentinel config-epoch mymaster 1
sentinel leader-epoch mymaster 1
sentinel current-epoch 1

sentinel known-replica mymaster 172.31.85.150 6380

sentinel known-replica mymaster 172.19.0.1 6379

sentinel known-sentinel mymaster 172.19.0.6 26379 f8cbfbc4fa2fb86c0f045a6408a4350e0ba1c38a

sentinel known-sentinel mymaster 172.19.0.7 26379 bae576e7f8154bc09849c1766637ce87011a7339

sentinel known-replica mymaster 172.19.0.2 6379
```

## Validate

for redis replication

```
docker exec -it redis-master /bin/bash
```

```
redis-cli -a password INFO replication
```

```
# Replication
role:master
connected_slaves:2
slave0:ip=172.20.0.2,port=6379,state=online,offset=13648,lag=0
slave1:ip=172.20.0.4,port=6379,state=online,offset=13234,lag=1
master_failover_state:no-failover
master_replid:fd56babf8996b7c3ebc48727f3df84d8b5a5e68e
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:13648
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:13648
```

for redis sentinel

```
docker exec -it redis-sentinel-2 /bin/bash
```

```
redis-cli -p 26379 INFO sentinel
```

```
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_tilt_since_seconds:-1
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=172.31.85.150:6380,slaves=3,sentinels=3
```